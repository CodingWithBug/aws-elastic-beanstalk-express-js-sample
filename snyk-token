pipeline {
  agent any

  options {
    buildDiscarder(logRotator(numToKeepStr: '20'))
    timestamps()
    ansiColor('xterm')
    timeout(time: 60, unit: 'MINUTES')
  }

  environment {
    REGISTRY_URL = 'https://index.docker.io/v1/'
    IMAGE_REPO   = 'panyunpeng/isec6000_assignment2'
    IMAGE_TAG    = "${env.BUILD_NUMBER}"
    REPORT_DIR   = 'reports'
  }

  stages {
    stage('Checkout') {
      steps {
        echo '=== [Checkout] Begin ==='
        checkout scm
        // Use bash here so we can enable pipefail and strict modes
        sh '''
bash -Eeuo pipefail <<'BASH'
mkdir -p "${REPORT_DIR}/junit" "${REPORT_DIR}/logs" "${REPORT_DIR}/security" "${REPORT_DIR}/docker"
echo "Workspace: $(pwd)" | tee -a "${REPORT_DIR}/logs/checkout.log"
echo "Branch: ${GIT_BRANCH:-unknown}" | tee -a "${REPORT_DIR}/logs/checkout.log"
git log -1 --pretty=oneline | tee -a "${REPORT_DIR}/logs/checkout.log"

# Log Parser rules file (used only if the plugin is installed)
cat > "${REPORT_DIR}/logparser-rules.txt" <<'RULES'
error /(^|[^a-zA-Z])(ERR(OR)?|FAIL(ED)?|CRITICAL|FATAL)([^a-zA-Z]|$)/
warning /(^|[^a-zA-Z])(WARN(ING)?|DEPRECATED)([^a-zA-Z]|$)/
RULES
BASH
'''
        script {
          def rev = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
          currentBuild.description = "img: ${env.IMAGE_TAG} | git: ${rev}"
        }
        echo '=== [Checkout] Done ==='
      }
    }

    stage('Install & Test (Node 16)') {
      steps {
        echo '=== [Install & Test] Begin ==='
        script {
          // Run Node steps in a clean container; workspace is bind-mounted by Jenkins Docker Pipeline
          docker.image('node:16').inside('-u root') {
            sh '''
bash -Eeuo pipefail <<'BASH'
echo "[Node env]" | tee -a "${REPORT_DIR}/logs/node-env.log"
node -v | tee -a "${REPORT_DIR}/logs/node-env.log"
npm -v  | tee -a "${REPORT_DIR}/logs/node-env.log"

echo "[npm install]" | tee -a "${REPORT_DIR}/logs/npm-install.log"
(npm install 2>&1 | tee -a "${REPORT_DIR}/logs/npm-install.log}") || true

echo "[npm ci]" | tee -a "${REPORT_DIR}/logs/npm-ci.log"
(npm ci 2>&1 | tee -a "${REPORT_DIR}/logs/npm-ci.log}") || true

echo "[npm test]" | tee -a "${REPORT_DIR}/logs/npm-test.log"
# If you use Jest, prefer jest-junit to produce real JUnit XML; we add a fallback below.
export JEST_JUNIT_OUTPUT="${REPORT_DIR}/junit/junit.xml"
(npm test --if-present 2>&1 | tee -a "${REPORT_DIR}/logs/npm-test.log}") || true

# Create a minimal JUnit report if none was produced (prevents Jenkins from complaining)
if [ ! -s "${REPORT_DIR}/junit/junit.xml" ]; then
  cat > "${REPORT_DIR}/junit/junit.xml" <<'XML'
<?xml version="1.0" encoding="UTF-8"?>
<testsuite name="dummy" tests="1" failures="0" errors="0" skipped="0">
  <testcase classname="dummy" name="no-tests-detected"/>
</testsuite>
XML
  echo "No real JUnit produced; wrote a dummy report."
fi
BASH
'''
          }
        }
        echo '=== [Install & Test] Done ==='
      }
    }

    stage('Security Scan (Snyk, fail on High/Critical)') {
      environment { SNYK_TOKEN = credentials('snyk-token') }
      steps {
        echo '=== [Security Scan] Begin ==='
        script {
          // Pass SNYK_TOKEN into the container explicitly
          docker.image('node:16').inside('-u root -e SNYK_TOKEN') {
            sh '''
bash -Eeuo pipefail <<'BASH'
echo "[Snyk setup]" | tee -a "${REPORT_DIR}/logs/snyk.log"
npm install -g snyk 2>&1 | tee -a "${REPORT_DIR}/logs/snyk.log"
snyk auth "${SNYK_TOKEN}" 2>&1 | tee -a "${REPORT_DIR}/logs/snyk.log"

echo "[Snyk test JSON]" | tee -a "${REPORT_DIR}/logs/snyk.log"
# Fail build on high/critical issues; also store machine-readable JSON
bash -o pipefail -c 'snyk test --severity-threshold=high --json \
  | tee "${REPORT_DIR}/security/snyk-report.json"'

echo "[Snyk test SARIF]" | tee -a "${REPORT_DIR}/logs/snyk.log"
# Produce SARIF for dashboards; non-fatal
snyk test --severity-threshold=high \
  --sarif-file-output="${REPORT_DIR}/security/snyk-report.sarif" \
  2>&1 | tee -a "${REPORT_DIR}/logs/snyk.log" || true
BASH
'''
          }
        }
        echo '=== [Security Scan] Done ==='
      }
    }

    stage('Build & Push Docker Image') {
      steps {
        echo '=== [Docker Build & Push] Begin ==='
        script {
          // Optionally enable BuildKit with: withEnv(['DOCKER_BUILDKIT=1']) { ... }
          def app = docker.build("${IMAGE_REPO}:${IMAGE_TAG}")
          docker.withRegistry(env.REGISTRY_URL, 'dockerhub-credentials') {
            app.push("${IMAGE_TAG}")
            app.push('latest')
          }
          sh '''
bash -Eeuo pipefail <<'BASH'
docker image inspect "${IMAGE_REPO}:${IMAGE_TAG}" \
  > "${REPORT_DIR}/docker/image-inspect.json"
docker history --no-trunc "${IMAGE_REPO}:${IMAGE_TAG}" \
  > "${REPORT_DIR}/docker/image-history.txt"
BASH
'''
        }
        echo '=== [Docker Build & Push] Done ==='
      }
    }
  }

  post {
    always {
      // Publish JUnit (allow empty to avoid failing the build when no tests)
      junit allowEmptyResults: true, testResults: "${REPORT_DIR}/junit/**/*.xml"

      // Archive all reports (plus a legacy Snyk JSON name, if present)
      archiveArtifacts artifacts: """
        ${REPORT_DIR}/**/*,
        snyk-report.json
      """.stripIndent().trim(), allowEmptyArchive: true

      // Try to annotate console logs if Log Parser plugin is available (compatible params)
      script {
        try {
          logParser(
            projectRulePath: "${REPORT_DIR}/logparser-rules.txt",
            useProjectRule: true,
            showGraphs: true,
            unstableOnWarning: false,
            failBuildOnError: false
          )
        } catch (ignored) {
          echo "Log Parser plugin not installed or API mismatch; skipping."
        }
      }

      echo "Artifacts archived under '${REPORT_DIR}/'."
    }

    success {
      echo "✅ Build succeeded. Image pushed: ${env.IMAGE_REPO}:${env.IMAGE_TAG}"
    }
    unstable {
      echo "⚠️ Build marked UNSTABLE. Please review test and security results."
    }
    failure {
      echo "❌ Build failed. Check detailed logs in ${env.REPORT_DIR}/logs/."
    }
  }
}
